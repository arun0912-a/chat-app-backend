<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <style>
        /* General Reset */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }

        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f2f2f2;
            color: #000;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark {
            background-color: #121212;
            color: #e0e0e0;
        }

        header {
            background-color: #4a90e2;
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
        }

        body.dark header {
            background-color: #1f1f1f;
            color: #4a90e2;
        }

        #chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            overflow-y: auto;
            gap: 0.5rem;
        }

        ul#messages {
            list-style: none;
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        ul#messages li {
            padding: 0.5rem 1rem;
            border-radius: 15px;
            margin-bottom: 0.3rem;
            max-width: 70%;
            word-wrap: break-word;
            transition: background-color 0.3s, color 0.3s;
        }

        li.me {
            background-color: #4a90e2;
            color: white;
            align-self: flex-end;
        }

        body.dark li.me {
            background-color: #357ABD;
        }

        li.other {
            background-color: #e1e1e1;
            color: black;
            align-self: flex-start;
        }

        body.dark li.other {
            background-color: #333;
            color: #e0e0e0;
        }

        .system-message {
            text-align: center;
            font-style: italic;
            color: #777;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        body.dark .system-message {
            color: #aaa;
        }

        #input-container {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background-color: white;
            transition: background-color 0.3s;
        }

        body.dark #input-container {
            background-color: #1f1f1f;
        }

        #input-container input {
            flex: 1;
            padding: 0.7rem;
            border-radius: 20px;
            border: 1px solid #ccc;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark #input-container input {
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #555;
        }

        #input-container button {
            padding: 0.7rem 1rem;
            border: none;
            background-color: #4a90e2;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #input-container button:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        #input-container button:hover:not(:disabled) {
            background-color: #357ABD;
        }

        #status {
            text-align: center;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: #555;
            transition: color 0.3s;
        }

        body.dark #status {
            color: #ccc;
        }

        /* Bottom controls */
        #controls {
            padding:0.5rem;
            background:#fff;
            display:flex;
            gap:0.5rem;
            flex-wrap:wrap;
            transition: background-color 0.3s;
        }

        body.dark #controls {
            background: #1f1f1f;
        }

        #controls input {
            flex:1;
            padding:0.5rem;
            border-radius: 10px;
            border:1px solid #ccc;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark #controls input {
            background:#333;
            color:#e0e0e0;
            border:1px solid #555;
        }

        #controls button {
            padding:0.5rem 1rem;
            border:none;
            border-radius:10px;
            cursor:pointer;
            background-color:#4a90e2;
            color:white;
            transition: background-color 0.3s;
        }

        #controls button:hover:not(:disabled) {
            background-color: #357ABD;
        }

        @media(max-width: 600px){
            li.me, li.other { max-width: 90%; }
            header { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

<header>ðŸ’¬ Chat App</header>

<div id="status">Disconnected</div>

<div id="chat-container">
    <ul id="messages"></ul>
</div>

<div id="input-container">
    <input id="msg" type="text" placeholder="Type a message..." autocomplete="off">
    <button id="send" disabled>Send</button>
</div>

<div id="controls">
    <input id="room" type="text" value="lobby" placeholder="Room">
    <input id="username" type="text" value="guest" placeholder="Username">
    <button id="connect">Connect</button>
    <button id="disconnect" disabled>Disconnect</button>
    <button id="darkmode-toggle">Toggle Dark Mode</button>
</div>

<script>
    let ws = null;
    const status = document.getElementById("status");
    const messages = document.getElementById("messages");
    const connectBtn = document.getElementById("connect");
    const disconnectBtn = document.getElementById("disconnect");
    const sendBtn = document.getElementById("send");
    const usernameInput = document.getElementById("username");
    const darkToggle = document.getElementById("darkmode-toggle");

    function addMessage(username, content, senderType, time) {
        const li = document.createElement("li");
        li.className = senderType;
        li.textContent = `[${time}] ${username}: ${content}`;
        messages.appendChild(li);
        messages.scrollTop = messages.scrollHeight;
    }

    connectBtn.onclick = () => {
        const room = document.getElementById("room").value || "lobby";
        const username = encodeURIComponent(usernameInput.value || "guest");

        // ðŸ”‘ auto-pick wss:// if site is https://
        const protocol = location.protocol === "https:" ? "wss://" : "ws://";
        const url = `${protocol}${location.host}/ws/${room}?username=${username}`;

        ws = new WebSocket(url);

        ws.onopen = () => {
            status.textContent = `âœ… Connected to ${room} as ${usernameInput.value}`;
            connectBtn.disabled = true;
            disconnectBtn.disabled = false;
            sendBtn.disabled = false;
        };

    ws.onmessage = (evt) => {
            try {
                const obj = JSON.parse(evt.data);
                const time = obj.timestamp ? new Date(obj.timestamp).toLocaleTimeString() : "";

                if (obj.type === "system") {
                    const div = document.createElement("div");
                    div.className = "system-message";
                    div.textContent = `[${time}] ${obj.content}`;
                    messages.appendChild(div);
                    messages.scrollTop = messages.scrollHeight;
                } else if (obj.type === "chat") {
                    addMessage(
                        obj.username,
                        obj.content,
                        obj.username === usernameInput.value ? "me" : "other",
                        time
                    );
                }
            } catch (e) {
                addMessage("Server", evt.data, "system", "");
            }
        };

        ws.onclose = () => {
            status.textContent = "Disconnected";
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            sendBtn.disabled = true;
        };

        ws.onerror = (e) => {
            console.error("WebSocket error", e);
        };
    };

    disconnectBtn.onclick = () => {
        if (ws) ws.close();
    };

    sendBtn.onclick = () => {
        const input = document.getElementById("msg");
        const text = input.value.trim();
        if (ws && text) {
            ws.send(JSON.stringify({ content: text }));
            input.value = "";
        }
    };

    document.getElementById("msg").addEventListener("keyup", (e) => {
        if (e.key === "Enter") sendBtn.click();
    });

    // Dark mode toggle
    darkToggle.onclick = () => {
        document.body.classList.toggle("dark");
    };
</script>

</body>
</html>
